# Generated APP Infra

我们当前这个应用时模型按照一个 workflow 生成出来的。
这个 workflow 可以生成很多很多这样的应用。
这些应用都是同样的结构，它由三个组件组成：
- 业务逻辑组件。也是 web api server，有 http 接口可以调用，做业务逻辑的计算，数据存在 postgreSQL 中。
- 通信组件，基于 Centrifugo。用来保持用户的 websocket 连接，实现应用里的通信功能。
- 异步长任务容器组件，基于 Restate，用来承载同步返回的长任务，或者多个任务串联。

这三个部分需要能通过 http 接口互相通信。

当用户有功能是我们通过业务逻辑组件+postgreSQL 表达不了时，我们可以通过一个叫做 Integration 的概念，来扩展功能。主要有两种扩展方式：
- 声明依赖的中间件、工具和提供接口。通过安转中间件来解决，例如用户需要上传文件，可以通过安装对象存储中间件 minio 来解决。
- 调用外部平台服务。例如用户需要大模型生图，我们可以在 integration 中发出外部平台的 api 调用。

我们现在想设计一个调试&部署工具，能帮助这些应用既能在本地调试业务逻辑组件，又能把所有业务逻辑组件部署到云端。它需要满足一下需求：
- 我需要分层描述（应用层/运维层）。每个应用在应用层通过独立的 json 描述自己需要的所有中间件的基本信息。例如业务逻辑组件需要的 postgreSQL，通信组件需要的 Centrifugo，异步长任务容器组件需要的 Restate。但不描述具体规格、部署等信息。如果需要的中间件、或者服务需要能被公网访问，例如 minio，那么需要一个字段声明。
- 在运维层也只使用简单的方式表达部署的基本方式，然后用工具来生成真正的部署信息。用户可以只要简单填写以下信息：
  - 使用哪家云服务
  - 使用容器部署还是使用兼容的云服务
  - 规格信息（固定的 tiny/medium/large 三种规格）
  如果针对某个中间件有特殊需求，用户可以单独声明这三项来覆盖掉。。
- 部署工具本来就已经提供了阿里云、火山引擎、aws 的部署能力（我们内置了所需要的 key 等所有必要信息）。并且在所有云上都同时支持容器部署所需要的中间件和直接使用云服务两种形式。
- 用户在本地研发时，任何组件都可以单独自己来启动，不由工具管理的。本地部署规定使用 docker desktop 的 k8s，没有其他选择。

接下来，你来一步一步按照下面的任务帮助我设计和完成这个工具。注意：
1. 为了清晰你的每一个任务都只产出一个文档。且文件名用 `task-{nubmer}-` 开头。放在 `prompt/output/deploy` 下。
2. 每一次你的输出，都要绝对简洁，只完成要你做的设计部分，不要添加无关的人力、成本估算之类信息。

## 任务

### 任务1. 完成业务逻辑层的 json 结构设计。
三个应用有自己的 json ，描述：
- 自己叫什么名字。（其他一按照名字约定来进行 http 通信）
- 自己依赖的中间件、工具的名称和版本，以及具体中间件需要填写的必须的 config。注意，中间件、对立工具里有很多 config 都是和规格、性能之类有关的，这些都不应该在这个 json 里填写。这个 json 里只填写和业务逻辑有直接关系的信息。

注意：
- integration 需要的中间件、独立部署的工具，也是描述在主应用的依赖中。
- 三个应用默认就都可以互相通信，不需要额外描述。
- 你的设计应该要方便我们以后能添加更多的应用。

### 任务2. 生成详细部署信息的脚本
我们需要一种更简单的表达方式，然后用工具来生成真正的部署信息。用户可以只要简单填写以下信息：
- 使用 k8s 独立部署还是使用云服务
- 使用哪家云服务
- 规格信息（先固定 type1/type2/type3 三种规格，未来应该能支持扩展）

如果针对某个中间件、工具有特殊需求，用户可以单独声明这三项来覆盖掉。特别的，对于规格信息如果要覆盖，可以跳出三种规定规格，自己直接指定更细致的规格。

注意：
- 用户可以自定义环境，例如 dev/test/prod。每个环境一个单独的文件表示。每一个应用都单独写。这一位这如果有 3 个环境，那么总共应该写 3*3=9 个文件。
 - 同一个环境下，因为考虑到要通信的问题，三个应用只能选择相同的云服务，或者都是本地。原则都是云服务的话，三个应用可是一不同的部署方式，例如有的是 ec2，有的是 k8s。
- 你设计的 json 应该结构应该尽量简洁，具备扩展性。
- 应用和需要 publicAccess 的中间件、工具（例如minio），有个选填字段配置域名。


### 任务3. 部署工具的实现设计
你来对我们的部署工具进行实现设计。要求：
1. 底层统一使用 Terraform，不要引入其他的部署工具。在本地，固定就用 docker desktop k8s provider。
2. 工具支持用户定义的任何一个环境的三个应用一键部署/重启/删除。也支持某一个单独环境下的单独应用的一键部署/重启/删除。注意，本地还要支持单独声明主应用用户自己通过 nodejs 启动。

### 任务4. 实现部署工具
严格按照 `prompt/output/deploy/task-3-deploy-tool-design.md` 来实现。
注意：
1. 不要跳过任何步骤，不要用任何简化的替代方案来实施。遇到是在无法解决的问题，应该直接停下来问我。
2. 每个阶段执行完，如果有测试用例应该直接执行测试用例，确保真确之后再继续执行。